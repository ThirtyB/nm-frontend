# 前端心跳服务文档

## 功能概述

为前端项目添加了一个定时心跳服务，每30秒向后端发送心跳报告，包含IP地址和服务名称"前端"。

## 实现细节

### 1. 心跳服务模块 (`src/services/heartbeat.js`)

- **功能**: 定时向后端发送心跳报告
- **间隔**: 30秒
- **目标地址**: `http://127.0.0.1:8000/heartbeat/report`
- **数据格式**:
  ```json
  {
    "ip_address": "客户端IP地址",
    "service_name": "前端"
  }
  ```

### 2. 自动启动

在 `src/main.js` 中，应用启动后自动启动心跳服务：
```javascript
setTimeout(() => {
  heartbeatService.start()
}, 1000) // 延迟1秒启动
```

### 3. 管理界面

在系统状态页面 (`src/views/SystemStatus.vue`) 添加了心跳服务管理卡片：

- **服务状态显示**: 显示运行状态、发送间隔、服务名称
- **开关控制**: 可以启用/禁用心跳服务
- **手动发送**: 可以立即发送一次心跳报告
- **最后发送时间**: 显示最近一次成功发送的时间

## API 接口

### POST /heartbeat/report

**请求格式**:
```bash
curl -X 'POST' \
  'http://127.0.0.1:8000/heartbeat/report' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "ip_address": "10.1.11.131",
  "service_name": "前端"
}'
```

**成功响应**:
```json
{
  "status": "success",
  "message": "探活报告已记录",
  "data": {
    "id": 130,
    "ip_address": "10.1.11.131",
    "service_name": "前端",
    "report_time": "2025-11-23T12:04:44.189005"
  }
}
```

## 特性

1. **智能IP获取**: 使用多种方法获取客户端真实IP地址
   - **WebRTC方法**: 优先获取局域网IP地址（如192.168.x.x, 10.x.x.x）
   - **公共API备用**: 如果WebRTC失败，使用多个公共API获取IP
   - **IP验证**: 验证IP地址格式的有效性
2. **实时IP显示**: 在管理界面显示当前获取到的IP地址
3. **IP刷新功能**: 用户可以手动刷新IP地址
4. **错误处理**: 发送失败不会影响定时任务继续执行
5. **单例模式**: 确保全局只有一个心跳服务实例
6. **生命周期管理**: 页面关闭时自动停止心跳服务
7. **用户界面**: 提供友好的管理界面

## IP获取策略

### 优先级顺序：
1. **WebRTC获取本地IP** - 获取局域网真实IP地址
   - 优先返回：192.168.x.x, 10.x.x.x, 172.x.x.x 网段
   - 排除：127.0.0.1, 169.254.x.x (无效地址)
   
2. **公共API获取** - 备用方案
   - 使用多个API服务确保可用性
   - 包含：api.ipify.org, httpbin.org, api.ip.sb, ifconfig.me
   
3. **默认IP** - 最后备用
   - 如果所有方法都失败，使用 192.168.1.100

## 使用方法

1. **自动运行**: 应用启动后自动开始发送心跳
2. **查看状态**: 访问系统状态页面查看心跳服务状态
3. **手动控制**: 通过界面开关可以启用/禁用服务
4. **立即发送**: 点击"立即发送"按钮可以手动触发一次心跳

## 注意事项

1. 心跳服务会在应用启动1秒后自动开始
2. 关闭浏览器标签页时会自动停止心跳服务
3. 网络错误不会中断定时任务，会继续尝试发送
4. IP地址获取优先使用公共API，失败时使用本地IP

## 文件结构

```
src/
├── services/
│   └── heartbeat.js          # 心跳服务核心模块
├── main.js                   # 应用入口，自动启动心跳服务
└── views/
    └── SystemStatus.vue      # 系统状态页面，包含心跳管理界面
```

## 测试验证

可以通过以下方式验证心跳服务是否正常工作：

1. 打开浏览器开发者工具的Network面板
2. 查看是否有每30秒发送一次的POST请求到 `/heartbeat/report`
3. 检查请求是否返回200状态码
4. 在系统状态页面查看心跳服务状态和最后发送时间